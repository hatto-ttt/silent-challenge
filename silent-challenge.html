<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ å®Œå…¨ç‰ˆ</title>
<style>
:root{
  --accent:#007aff;
  --green:#34c759;
  --yellow:#ffcc00;
  --red:#ff3b30;
  --bg:#fff;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif;
  background:var(--bg);
  margin:0;
  padding:40px 24px;
  text-align:center;
  color:#111;
}

h1{
  font-size:28px;
  font-weight:700;
  margin-bottom:40px;
}

.container{
  max-width:480px;
  margin:auto;
}

.settings{
  display:flex;
  flex-direction:column;
  gap:20px;
  margin-bottom:20px;
}

.setting-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:16px;
  flex-wrap:wrap;
  gap:5px;
}

.setting-row input[type="number"]{
  padding:10px;
  border-radius:14px;
  border:1px solid #e5e5e7;
  background:#f9f9f9;
  text-align:right;
  font-size:16px;
}

.setting-row input[type="range"]{
  flex:1;
  margin-left:10px;
}

button{
  padding:16px;
  border-radius:18px;
  border:none;
  font-size:16px;
  font-weight:500;
  background:#000;
  color:#fff;
  margin-top:10px;
  cursor:pointer;
  transition:0.2s;
}
button:hover{
  transform:scale(1.05);
}
button.secondary{
  background:#f2f2f7;
  color:#111;
}

/* ä¸€æ™‚åœæ­¢/å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ æ¨ªä¸¦ã³ */
.pause-resume-container{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:10px;
}
.pause-resume-container button{
  padding:6px 12px;
  font-size:14px;
  border-radius:10px;
}

.db-display{
  font-size:36px;
  font-weight:700;
  margin-bottom:16px;
}

.bomb{
  font-size:100px;
  margin:0 auto 40px;
  display:block;
  transition:transform 0.2s;
}

.bomb.pulse{
  animation:pulse 0.8s infinite;
}

.bomb.shake{
  animation:shake 0.3s infinite;
}

@keyframes pulse{
  0%{ transform:scale(1);}
  50%{ transform:scale(1.2);}
  100%{ transform:scale(1);}
}

@keyframes shake{
  0%{ transform:translateX(0);}
  25%{ transform:translateX(-5px);}
  50%{ transform:translateX(5px);}
  75%{ transform:translateX(-5px);}
  100%{ transform:translateX(0);}
}

.footer{
  font-size:18px;
  line-height:1.8;
  margin-bottom:40px;
}

/* æˆåŠŸç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« */
.success-overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.95);
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:999;
  padding:40px 20px;
}

.success-text{
  font-size:48px;  
  font-weight:800;
  margin-bottom:30px;
  color:var(--accent);
  animation:pop 0.5s ease-out;
}

@keyframes pop{
  0%{ transform:scale(0.5); opacity:0;}
  60%{ transform:scale(1.2); opacity:1;}
  100%{ transform:scale(1); }
}

.score-box{
  font-size:20px; 
  line-height:1.6;
  margin-bottom:30px;
  font-weight:700;
  text-align:center;
}

.score-box div{
  margin:6px 0;
  animation:popScore 0.5s ease-out;
}

@keyframes popScore{
  0%{ transform:scale(0.7); opacity:0;}
  60%{ transform:scale(1.2); opacity:1;}
  100%{ transform:scale(1); }
}

.success-button{
  padding:16px 32px;
  border-radius:20px;
  border:1px solid rgba(0,0,0,0.2);
  font-size:18px;
  font-weight:600;
  backdrop-filter: blur(20px);
  background: rgba(255,255,255,0.3);
  color:#111;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  margin-bottom:30px;
  cursor:pointer;
  transition:transform 0.2s;
}
.success-button:hover{
  transform:scale(1.05);
}

.confetti-piece{
  position:absolute;
  width:8px;
  height:14px;
  top:-20px;
  opacity:0.9;
  animation:fall linear forwards;
}

@keyframes fall{
  to{
    transform:translateY(110vh) rotate(360deg);
    opacity:0;
  }
}

#waveform{
  width:100%;
  height:150px;
  border-radius:12px;
  background:#f9f9f9;
  margin-bottom:40px;
}
</style>
</head>
<body>

<h1>ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>

<div class="container">

<div class="settings">
  <!-- åˆ¶é™æ™‚é–“ åˆ†+ç§’ -->
  <div class="setting-row">
    <span>â³ åˆ¶é™æ™‚é–“</span>
    <input type="number" id="timeMin" value="0" min="0" style="width:60px;"> åˆ†
    <input type="number" id="timeSec" value="30" min="0" max="59" style="width:60px;"> ç§’
  </div>

  <div class="setting-row">
    <span>ğŸ”Š ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³</span>
    <input type="number" id="threshold" value="60">
  </div>

  <div class="setting-row">
    <span>ğŸ’£ è¨­å®šå›æ•°</span>
    <input type="number" id="limit" value="5">
  </div>

  <div class="setting-row">
    <span>ğŸš æ„Ÿåº¦</span>
    <input type="range" id="sensitivity" min="0.5" max="2" step="0.05" value="1.5">
    <span id="sensitivityValue">1.5</span>
  </div>

  <button onclick="start()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button class="secondary" onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>

  <div class="pause-resume-container">
    <button onclick="pauseGame()">â¸ ä¸€æ™‚åœæ­¢</button>
    <button onclick="resumeGame()">â–¶ å†ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>
</div>

<div class="db-display" id="db">0 dB</div>

<canvas id="waveform"></canvas>

<div class="bomb" id="bomb">ğŸ’£</div>

<div class="footer">
æ®‹ã‚Šæ™‚é–“ï¼š<span id="remain">0åˆ†0ç§’</span><br>
è¶…éå›æ•°ï¼š<span id="count">0</span>
</div>

</div>

<div id="successOverlay" class="success-overlay">
  <div class="success-text">ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼</div>

  <div class="score-box">
    <div id="scoreHistory"></div>
    <div id="scoreSilent"></div>
    <div id="scoreCount"></div>
  </div>

  <button class="success-button" onclick="closeSuccess()">ç”»é¢ã«æˆ»ã‚‹</button>

  <div id="confetti"></div>
</div>

<script>
let audioContext, analyser;
let running=false;
let paused=false;
let count=0;
let limit, threshold, timeLeft;
let timer;
let overHistory=[];
let longestSilent=0;
let currentSilent=0;
let confettiPlayed=false;

const bomb=document.getElementById("bomb");
const canvas=document.getElementById("waveform");
const ctx=canvas.getContext("2d");
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

let waveformData = [];
const maxPoints = canvas.width;

let cooldownActive = false;
const cooldownTime = 4;
let cooldownTimer;

let sensitivity = parseFloat(document.getElementById("sensitivity").value);
document.getElementById("sensitivity").addEventListener("input", (e)=>{
  sensitivity = parseFloat(e.target.value);
  document.getElementById("sensitivityValue").textContent = sensitivity.toFixed(2);
});

let data; 
let animationId;

function triggerCooldown(){
  cooldownActive = true;
  let remaining = cooldownTime;
  bomb.style.opacity = 0.5;
  cooldownTimer = setInterval(() => {
    remaining--;
    if(remaining <= 0){
      clearInterval(cooldownTimer);
      cooldownActive = false;
      if(!paused) bomb.style.opacity = 1;
    }
  }, 1000);
}

function addWaveform(db){
  if(waveformData.length>=maxPoints) waveformData.shift();
  waveformData.push(db);
}

function drawWaveform(){
  const w=canvas.width;
  const h=canvas.height;
  ctx.clearRect(0,0,w,h);
  if(waveformData.length<2) return;

  ctx.lineWidth=2;
  ctx.beginPath();
  for(let i=0;i<waveformData.length;i++){
    const x=i;
    const y=h*(1-waveformData[i]/100);
    const ratio = waveformData[i]/100;
    let r,g,b;
    if(ratio<0.5){
      const t=ratio/0.5;
      r=Math.floor(0+255*t);
      g=Math.floor(192+(255-192)*t);
      b=Math.floor(255-255*t);
    }else{
      const t=(ratio-0.5)/0.5;
      r=255;
      g=Math.floor(255-255*t);
      b=0;
    }
    ctx.strokeStyle=`rgb(${r},${g},${b})`;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  ctx.strokeStyle="red";
  ctx.lineWidth=2;
  const yLine = h*(1-threshold/100);
  ctx.beginPath();
  ctx.moveTo(0,yLine);
  ctx.lineTo(w,yLine);
  ctx.stroke();
}

function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}åˆ†${s}ç§’`;
}

function update(){
  if(!running || paused) return;
  analyser.getByteFrequencyData(data);
  let sum = data.reduce((a,b)=>a+b,0);
  let avg = sum/data.length;
  let db = Math.round(avg*sensitivity);

  document.getElementById("db").textContent = db+" dB";

  currentSilent += 1/60;
  if(currentSilent>longestSilent) longestSilent=currentSilent;

  if(db>=threshold && !cooldownActive){
    count++;
    const elapsed = parseInt((parseInt(document.getElementById("timeMin").value||0)*60) + parseInt(document.getElementById("timeSec").value||0)) - timeLeft;
    overHistory.push({time: elapsed, db});
    currentSilent=0;
    document.getElementById("count").textContent = count;
    triggerCooldown();
    if(count>=limit){
      explode();
      return;
    }
  }

  if(limit-count<=2 && count<limit){
    if(!paused && !bomb.classList.contains("pulse")){
      bomb.classList.add("pulse","shake");
    }
  }else{
    bomb.classList.remove("pulse","shake");
  }

  addWaveform(db);
  drawWaveform();
  animationId=requestAnimationFrame(update);
}

async function start(){
  if(running) return;
  const minutes = parseInt(document.getElementById("timeMin").value)||0;
  const seconds = parseInt(document.getElementById("timeSec").value)||0;
  timeLeft = minutes*60 + seconds;

  threshold=parseInt(document.getElementById("threshold").value);
  limit=parseInt(document.getElementById("limit").value);

  document.getElementById("remain").textContent=formatTime(timeLeft);
  count=0;
  overHistory=[];
  waveformData=[];
  longestSilent=0;
  currentSilent=0;
  confettiPlayed=false;
  paused=false;
  document.getElementById("count").textContent=count;
  bomb.textContent="ğŸ’£";
  bomb.className="bomb";
  bomb.style.opacity=1;
  running=true;

  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioContext = new AudioContext();
  analyser = audioContext.createAnalyser();
  const mic = audioContext.createMediaStreamSource(stream);
  mic.connect(analyser);
  analyser.fftSize=512;
  data=new Uint8Array(analyser.frequencyBinCount);

  update();

  timer=setInterval(()=>{
    if(paused) return;
    timeLeft--;
    document.getElementById("remain").textContent = formatTime(timeLeft);
    if(timeLeft<=0){
      clearInterval(timer);
      running=false;
      if(count<limit) showSuccess();
    }
  },1000);
}

function pauseGame(){
  if(!running || paused) return;
  paused=true;
  bomb.style.opacity=0.5;
  bomb.classList.remove("pulse","shake");
  cancelAnimationFrame(animationId);
}

function resumeGame(){
  if(!running || !paused) return;
  paused=false;
  bomb.style.opacity=1;
  update();
}

function explode(){
  running=false;
  clearInterval(timer);
  clearInterval(cooldownTimer);
  bomb.textContent="ğŸ’¥";
  bomb.className="bomb";
  bomb.style.opacity=1;

  const ctxOsc = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctxOsc.createOscillator();
  const gain = ctxOsc.createGain();
  osc.type='sine';
  osc.frequency.setValueAtTime(60,ctxOsc.currentTime);
  gain.gain.setValueAtTime(1,ctxOsc.currentTime);
  osc.connect(gain);
  gain.connect(ctxOsc.destination);
  osc.start();
  osc.stop(ctxOsc.currentTime+0.6);
}

function showSuccess(){
  if(overHistory.length){
    document.getElementById("scoreHistory").innerHTML = "ğŸ”Š éŸ³é‡å±¥æ­´:<br>" +
      overHistory.map(entry=>{
        const m=Math.floor(entry.time/60);
        const s=entry.time%60;
        return `${m}åˆ†${s}ç§’: ${entry.db} dB`;
      }).join("<br>");
  }else{
    document.getElementById("scoreHistory").textContent="ğŸ”Š éŸ³é‡å±¥æ­´: ãªã—";
  }

  document.getElementById("scoreSilent").textContent =
    "ğŸ¤« æœ€é•·ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ™‚é–“: "+longestSilent.toFixed(1)+" ç§’";
  document.getElementById("scoreCount").textContent =
    "ğŸ’£ æœ€çµ‚è¶…éå›æ•°: "+count+" å›";

  document.getElementById("successOverlay").style.display="flex";

  if(!confettiPlayed){
    confettiPlayed=true;
    for(let i=0;i<70;i++){
      const piece=document.createElement("div");
      piece.className="confetti-piece";
      piece.style.left=Math.random()*100+"vw";
      piece.style.background=["#007aff","#34c759","#ffcc00","#ff3b30"][Math.floor(Math.random()*4)];
      piece.style.animationDuration=(Math.random()*2+2)+"s";
      document.getElementById("confetti").appendChild(piece);
      setTimeout(()=>piece.remove(),4000);
    }
  }
}

function closeSuccess(){
  document.getElementById("successOverlay").style.display="none";
  document.getElementById("confetti").innerHTML="";
}

function resetGame(){
  running=false;
  paused=false;
  clearInterval(timer);
  clearInterval(cooldownTimer);
  cooldownActive=false;
  bomb.textContent="ğŸ’£";
  bomb.className="bomb";
  bomb.style.opacity=1;
  document.getElementById("db").textContent="0 dB";
  waveformData=[];
  document.getElementById("remain").textContent="0åˆ†0ç§’";
  document.getElementById("count").textContent="0";
  document.getElementById("successOverlay").style.display="none";
  document.getElementById("confetti").innerHTML="";
  confettiPlayed=false;
}
</script>
</body>
</html>